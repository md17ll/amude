<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙÙŠ Ø¹Ø§Ù…ÙˆØ¯Ø§</title>

  <style>
    :root{
      --green:#1f9d6a;
      --green-dark:#167a52;
      --bg:#f3faf6;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#d1fae5;
      --danger:#b42318;
      --shadow:0 10px 26px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .hidden{display:none !important}

    /* ===== Loading Overlay ===== */
    #loading{
      position:fixed; inset:0;
      background:linear-gradient(135deg,var(--green),var(--green-dark));
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      flex-direction:column;
      z-index:9999;
      transition:opacity .25s ease;
    }
    #loading.hide{opacity:0; pointer-events:none}
    #loading .pill{font-size:44px}
    #loading .msg{margin-top:10px; opacity:.95; text-align:center; line-height:1.6}

    /* ===== Layout ===== */
    #publicWrapper{
      max-width:760px;
      margin:auto;
      padding:24px 16px 110px;
    }
    .main-title{
      text-align:center;
      font-size:28px;
      color:var(--green-dark);
      margin:0 0 18px;
      font-weight:900;
      letter-spacing:.2px;
    }

    /* Search */
    .search input{
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--line);
      font-size:16px;
      outline:none;
      background:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.06);
    }

    /* Filters */
    .filters{
      display:flex;
      gap:10px;
      margin-top:14px;
    }
    .filters button{
      flex:1;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:14px;
      transition:transform .05s ease, background .15s ease, color .15s ease, border-color .15s ease;
      user-select:none;
    }
    .filters button:active{transform:scale(.99)}
    .filters button.active{
      background:var(--green);
      color:#fff;
      border-color:var(--green);
      font-weight:900;
    }

    .section-title{
      font-size:20px;
      margin:22px 0 12px;
      color:var(--green-dark);
      font-weight:900;
    }

    /* Cards */
    .card{
      background:var(--card);
      border-radius:18px;
      padding:16px;
      margin-bottom:14px;
      box-shadow:var(--shadow);
      border:1px solid rgba(209,250,229,.35);
    }
    .card-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .card h3{
      margin:0;
      font-size:18px;
      font-weight:900;
    }
    .meta{
      font-size:14px;
      color:var(--muted);
      margin-top:4px;
      line-height:1.6;
    }
    .badge{
      display:inline-block;
      padding:6px 14px;
      border-radius:999px;
      font-size:13px;
      font-weight:900;
      white-space:nowrap;
      align-self:flex-start;
    }
    .open{background:#e6f7ef;color:var(--green-dark)}
    .closed{background:#fdeaea;color:var(--danger)}
    .actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      text-decoration:none;
      font-size:14px;
    }

    /* Empty state */
    .empty{
      background:#fff;
      border:1px dashed rgba(22,122,82,.25);
      border-radius:18px;
      padding:18px;
      color:var(--muted);
      text-align:center;
      box-shadow:0 8px 22px rgba(0,0,0,.05);
    }

    /* ===== Admin lock (transparent + smaller) ===== */
    #lockBtn{
      position:fixed;
      bottom:18px;
      left:18px;
      width:34px;
      height:34px;
      border-radius:10px;
      background:transparent;   /* Ø´ÙØ§Ù ØªÙ…Ø§Ù…Ø§Ù‹ */
      border:0;
      padding:0;
      cursor:pointer;
      z-index:200;
      opacity:.28;
      transition:opacity .15s ease, transform .05s ease;
    }
    #lockBtn:hover{opacity:.75}
    #lockBtn:active{transform:scale(.98)}
    #lockBtn svg{width:22px;height:22px;display:block;margin:auto;fill:var(--green-dark);}

    /* ===== Modal base ===== */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
      padding:18px;
    }
    .modal.hidden{display:none}
    .box{
      width:100%;
      max-width:920px;
      background:#fff;
      border-radius:18px;
      box-shadow:0 16px 40px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .boxHeader{
      padding:14px 16px;
      background:linear-gradient(135deg,var(--green),var(--green-dark));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .boxHeader h2{margin:0;font-size:16px;font-weight:900}
    .boxHeader .hdrBtns{display:flex;gap:8px;flex-wrap:wrap}
    .hdrBtn{
      background:rgba(255,255,255,.16);
      color:#fff;
      border:1px solid rgba(255,255,255,.25);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .boxBody{padding:16px}

    .loginBox{
      max-width:420px;
      width:100%;
      background:#fff;
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 16px 40px rgba(0,0,0,.25);
    }
    .loginBody{padding:16px}

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media (min-width:920px){
      .grid{grid-template-columns:1.12fr .88fr}
    }

    .panel{
      background:#fff;
      border:1px solid rgba(209,250,229,.6);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 26px rgba(0,0,0,.06);
    }
    .panel h3{margin:0 0 10px;font-size:15px;color:var(--green-dark);font-weight:900}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{flex:1; min-width:180px}
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .field input, .field select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      font-size:14px;
    }

    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:14px;
      user-select:none;
    }
    .btn.primary{
      background:var(--green);
      color:#fff;
      border-color:var(--green);
      font-weight:900;
    }
    .btn.danger{
      background:#fff;
      color:var(--danger);
      border-color:rgba(180,35,24,.25);
      font-weight:900;
    }
    .hint{color:var(--muted); font-size:12px; line-height:1.6; margin-top:8px}
    .err{color:var(--danger);font-size:13px;margin-top:10px;display:none}

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(209,250,229,.7);
      background:#fff;
    }
    th,td{
      border-bottom:1px solid rgba(209,250,229,.8);
      padding:9px 8px;
      font-size:13px;
      text-align:center;
      vertical-align:top;
    }
    th{background:#eafaf2;color:var(--green-dark);font-weight:900}
    tr:last-child td{border-bottom:none}
    .tblBtns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .small{font-size:12px;padding:7px 10px;border-radius:10px}

    /* Toast */
    #toast{
      position:fixed;
      top:14px;
      left:50%;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:12000;
    }
    #toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(2px);
    }
  </style>

  <!-- Excel reader (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>

<body>
  <!-- Loading overlay -->
  <div id="loading">
    <div class="pill">ğŸ’Š</div>
    <div class="msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª...<br>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
  </div>

  <div id="publicWrapper">
    <h1 class="main-title">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙÙŠ Ø¹Ø§Ù…ÙˆØ¯Ø§</h1>

    <div class="search">
      <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙŠØ¯Ù„ÙŠØ© Ø¨Ø§Ù„Ø§Ø³Ù…" autocomplete="off" />
    </div>

    <!-- ØªØ±ØªÙŠØ¨ Ø§Ù„ÙÙ„ØªØ±Ø©: Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†ØŒ Ù…ØºÙ„Ù‚Ø© Ø§Ù„Ø¢Ù†ØŒ Ø§Ù„ÙƒÙ„ -->
    <div class="filters" id="filters">
      <button type="button" class="active" data-filter="open">Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†</button>
      <button type="button" data-filter="closed">Ù…ØºÙ„Ù‚Ø© Ø§Ù„Ø¢Ù†</button>
      <button type="button" data-filter="all">Ø§Ù„ÙƒÙ„</button>
    </div>

    <div class="section-title">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„Ø¢Ù†</div>
    <div id="list"></div>
  </div>

  <!-- Transparent small admin lock -->
  <button id="lockBtn" aria-label="Ù‚Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù†" title="Ù‚Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù†">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2zm-7-2a2 2 0 1 1 4 0v2h-4V7zm3.1 9.7-.3.3V18a.8.8 0 0 1-1.6 0v-1l-.3-.3a1.5 1.5 0 1 1 2.2 0z"/>
    </svg>
  </button>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Login modal -->
  <div class="modal hidden" id="loginModal">
    <div class="loginBox">
      <div class="boxHeader">
        <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
        <div class="hdrBtns">
          <button class="hdrBtn" id="loginCloseBtn" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
      <div class="loginBody">
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="loginUser" autocomplete="username" />
        </div>
        <div class="field" style="margin-top:10px">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="loginPass" type="password" autocomplete="current-password" />
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="loginBtn" type="button" style="flex:1;min-width:140px">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn" id="loginCancelBtn" type="button" style="flex:1;min-width:140px">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
        <div class="err" id="loginErr">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
      </div>
    </div>
  </div>

  <!-- Admin modal -->
  <div class="modal hidden" id="adminModal">
    <div class="box">
      <div class="boxHeader">
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª</h2>
        <div class="hdrBtns">
          <button class="hdrBtn" id="adminLogoutBtn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          <button class="hdrBtn" id="adminCloseBtn" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="boxBody">
        <div class="grid">
          <!-- Left: table -->
          <div class="panel">
            <h3>Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª</h3>
            <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ø£ÙŠ ØµÙŠØ¯Ù„ÙŠØ©ØŒ Ø£Ùˆ Ø±ÙØ¹ Ù…Ù„Ù Excel Ø´Ù‡Ø±ÙŠÙ‹Ø§ Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.</div>
            <div style="margin-top:12px; overflow:auto;">
              <table id="adminTable"></table>
            </div>
          </div>

          <!-- Right: actions + form -->
          <div class="panel">
            <h3>Ø±ÙØ¹ Excel Ø´Ù‡Ø±ÙŠÙ‹Ø§ (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„)</h3>
            <div class="row">
              <input id="excelFile" type="file" accept=".xlsx,.xls" class="btn" style="flex:1;min-width:220px" />
              <button class="btn danger" id="clearDataBtn" type="button" style="min-width:160px">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
            <div class="hint">
              Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙÙŠ Excel:
              <br><b>pharmacy</b>, <b>name</b>, <b>address</b>, <b>phone</b>, <b>open</b>, <b>openAmpm</b>, <b>close</b>, <b>closeAmpm</b>
              <br>Ø£Ùˆ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ: <b>Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</b>, <b>Ø§Ù„Ø§Ø³Ù…</b>, <b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</b>, <b>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</b>, <b>ÙØªØ­</b>, <b>ÙØªØ­ AM/PM</b>, <b>Ø¥ØºÙ„Ø§Ù‚</b>, <b>Ø¥ØºÙ„Ø§Ù‚ AM/PM</b>
              <br>Ø§Ù„ÙˆÙ‚Øª Ø¨Ù†Ø¸Ø§Ù… 12 Ø³Ø§Ø¹Ø© Ù…Ø«Ù„: <b>10:00</b> Ù…Ø¹ <b>AM</b> Ø£Ùˆ <b>PM</b>
            </div>

            <hr style="border:none;border-top:1px solid rgba(209,250,229,.9); margin:14px 0;">

            <h3 id="formTitle">Ø¥Ø¶Ø§ÙØ© ØµÙŠØ¯Ù„ÙŠØ©</h3>

            <div class="row">
              <div class="field" style="flex:1.2;min-width:220px">
                <label>Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</label>
                <input id="f_pharmacy" placeholder="Ù…Ø«Ø§Ù„: ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø´ÙØ§Ø¡" />
              </div>
              <div class="field" style="flex:1;min-width:200px">
                <label>Ø§Ù„Ø§Ø³Ù…</label>
                <input id="f_name" placeholder="Ù…Ø«Ø§Ù„: Ø¯. Ø£Ø­Ù…Ø¯" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field" style="flex:1.2;min-width:220px">
                <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <input id="f_address" placeholder="Ø¹Ø§Ù…ÙˆØ¯Ø§ - ..." />
              </div>
              <div class="field" style="flex:1;min-width:200px">
                <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input id="f_phone" placeholder="09xxxxxxxx" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field">
                <label>Ø³Ø§Ø¹Ø© Ø§Ù„ÙØªØ­</label>
                <input id="f_open" placeholder="10:00" />
              </div>
              <div class="field" style="min-width:120px">
                <label>AM/PM</label>
                <select id="f_openAmpm">
                  <option>AM</option>
                  <option>PM</option>
                </select>
              </div>
              <div class="field">
                <label>Ø³Ø§Ø¹Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</label>
                <input id="f_close" placeholder="03:00" />
              </div>
              <div class="field" style="min-width:120px">
                <label>AM/PM</label>
                <select id="f_closeAmpm">
                  <option>AM</option>
                  <option selected>PM</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="saveBtn" type="button" style="flex:1;min-width:160px">Ø­ÙØ¸</button>
              <button class="btn" id="cancelEditBtn" type="button" style="flex:1;min-width:160px">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            </div>

            <div class="hint" id="formHint"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
========================= */
const STORAGE_KEY = "amuda_pharmacies_v2";
const ADMIN_SESSION_KEY = "amuda_admin_session_v2";

/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† */
const ADMIN_USER = "amuda.br";
const ADMIN_PASS = "@Bb300300";

/* =========================
   Ø£Ø¯ÙˆØ§Øª
========================= */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function normalizeAmpm(v){
  const s = String(v ?? "").trim().toUpperCase();
  return (s === "PM") ? "PM" : "AM";
}
function normalizeTime(v){
  const s = String(v ?? "").trim();
  const m = s.match(/^(\d{1,2})(?::(\d{1,2}))?$/);
  if(!m) return "";
  let hh = Number(m[1]);
  let mm = Number(m[2] ?? 0);
  if(!Number.isFinite(hh) || !Number.isFinite(mm)) return "";
  if(hh < 1 || hh > 12) return "";
  if(mm < 0 || mm > 59) return "";
  return String(hh).padStart(2,"0") + ":" + String(mm).padStart(2,"0");
}
function uid(){
  // Ø¢Ù…Ù† ÙˆÙ…ÙˆØ­Ø¯
  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now();
}
const toastEl = document.getElementById("toast");
let toastTimer = null;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> toastEl.classList.remove("show"), 1800);
}

/* =========================
   Ù…Ù†Ø·Ù‚ Ø§Ù„ÙˆÙ‚Øª (12 Ø³Ø§Ø¹Ø© AM/PM)
========================= */
function toMinutes(t, ampm){
  const parts = String(t).split(":");
  if(parts.length !== 2) return null;
  const h0 = Number(parts[0]);
  const m0 = Number(parts[1]);
  if(!Number.isFinite(h0) || !Number.isFinite(m0)) return null;
  let h = h0;
  const ap = String(ampm).toUpperCase();
  if(ap === "PM" && h !== 12) h += 12;
  if(ap === "AM" && h === 12) h = 0;
  return h * 60 + m0;
}
function isOpenNow(p){
  const now = new Date();
  const n = now.getHours() * 60 + now.getMinutes();
  const o = toMinutes(p.open, p.openAmpm);
  const c = toMinutes(p.close, p.closeAmpm);
  if(o === null || c === null) return false;

  // Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
  if(o < c) return (n >= o && n < c);
  // Ù…Ù†Ø§ÙˆØ¨Ø© Ù„ÙŠÙ„ÙŠØ©
  return (n >= o || n < c);
}

/* =========================
   Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
========================= */
function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr.map(x => ({
      id: String(x.id ?? uid()),
      pharmacy: String(x.pharmacy ?? "").trim(),
      name: String(x.name ?? "").trim(),
      address: String(x.address ?? "").trim(),
      phone: String(x.phone ?? "").trim(),
      open: String(x.open ?? "").trim(),
      openAmpm: normalizeAmpm(x.openAmpm),
      close: String(x.close ?? "").trim(),
      closeAmpm: normalizeAmpm(x.closeAmpm),
    })).filter(x => x.pharmacy);
  }catch(_e){
    return [];
  }
}
function saveData(arr){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

/* =========================
   ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø²ÙˆØ§Ø±
========================= */
let pharmacies = [];
let currentFilter = "open"; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†
const listEl = document.getElementById("list");
const searchInput = document.getElementById("searchInput");
const publicWrapper = document.getElementById("publicWrapper");

function renderPublic(){
  const q = searchInput.value.trim().toLowerCase();

  let items = pharmacies
    .filter(p => p.pharmacy.toLowerCase().includes(q))
    .map(p => ({...p, __open: isOpenNow(p)}));

  if(currentFilter === "open") items = items.filter(p => p.__open);
  if(currentFilter === "closed") items = items.filter(p => !p.__open);

  // ØªØ±ØªÙŠØ¨: Ø§Ù„Ù…ÙØªÙˆØ­ Ø£ÙˆÙ„Ø§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ø§Ø³Ù…
  items.sort((a,b) => (b.__open - a.__open) || a.pharmacy.localeCompare(b.pharmacy, "ar"));

  if(items.length === 0){
    listEl.innerHTML = `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙŠØ¯Ù„ÙŠØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¢Ù†.</div>`;
    return;
  }

  listEl.innerHTML = items.map(p => {
    const badge = p.__open
      ? `<span class="badge open">Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†</span>`
      : `<span class="badge closed">Ù…ØºÙ„Ù‚Ø© Ø§Ù„Ø¢Ù†</span>`;

    const tel = p.phone ? `<a class="chip" href="tel:${escapeHtml(p.phone)}">ğŸ“ Ø§ØªØµØ§Ù„</a>` : "";

    return `
      <div class="card">
        <div class="card-top">
          <div>
            <h3>${escapeHtml(p.pharmacy)}</h3>
            ${p.name ? `<div class="meta">ğŸ‘¤ ${escapeHtml(p.name)}</div>` : ``}
          </div>
          ${badge}
        </div>
        <div class="meta">ğŸ“ ${escapeHtml(p.address || "â€”")}</div>
        <div class="meta">ğŸ“ ${escapeHtml(p.phone || "â€”")}</div>
        <div class="actions">${tel}</div>
      </div>
    `;
  }).join("");
}

/* ÙÙ„Ø§ØªØ± */
document.getElementById("filters").addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-filter]");
  if(!btn) return;
  document.querySelectorAll("#filters button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  currentFilter = btn.dataset.filter;
  renderPublic();
});
searchInput.addEventListener("input", renderPublic);

/* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© */
setInterval(() => {
  // Ù…Ø§ Ø±Ø­ Ù†Ø­Ø¯Ø« Ø¥Ø°Ø§ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…ÙØªÙˆØ­ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø£ÙŠ ØªØ¯Ø§Ø®Ù„ Ø¨ØµØ±ÙŠ
  if(!adminModal.classList.contains("hidden")) return;
  renderPublic();
}, 60 * 1000);

/* =========================
   Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
========================= */
const lockBtn = document.getElementById("lockBtn");
const loginModal = document.getElementById("loginModal");
const adminModal = document.getElementById("adminModal");
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginErr = document.getElementById("loginErr");

function setSession(on){
  if(on) sessionStorage.setItem(ADMIN_SESSION_KEY, "1");
  else sessionStorage.removeItem(ADMIN_SESSION_KEY);
}
function isAuthed(){
  return sessionStorage.getItem(ADMIN_SESSION_KEY) === "1";
}

function showLogin(){
  loginErr.style.display = "none";
  loginUser.value = "";
  loginPass.value = "";
  loginModal.classList.remove("hidden");
  setTimeout(() => loginUser.focus(), 0);
}
function hideLogin(){
  loginModal.classList.add("hidden");
}
function showAdmin(){
  // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø¨Ø§Ù„Ø®Ù„Ù Ù…Ø«Ù„ Ù…Ø§ Ø·Ù„Ø¨Øª
  publicWrapper.classList.add("hidden");
  adminModal.classList.remove("hidden");
  resetForm();
  drawAdminTable();
}
function hideAdmin(){
  adminModal.classList.add("hidden");
  publicWrapper.classList.remove("hidden");
  // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ù†Ø¯Ø± Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø²ÙˆØ§Ø± Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø£Ø¯Ù…Ù†
  renderPublic();
}

/* ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ */
lockBtn.addEventListener("click", () => {
  if(isAuthed()) showAdmin();
  else showLogin();
});

/* Ø£Ø²Ø±Ø§Ø± login */
document.getElementById("loginCloseBtn").addEventListener("click", hideLogin);
document.getElementById("loginCancelBtn").addEventListener("click", hideLogin);
document.getElementById("loginBtn").addEventListener("click", () => {
  const u = loginUser.value.trim();
  const p = loginPass.value;
  if(u === ADMIN_USER && p === ADMIN_PASS){
    setSession(true);
    hideLogin();
    showAdmin();
    toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…");
  }else{
    loginErr.style.display = "block";
  }
});

/* Ø£Ø²Ø±Ø§Ø± admin */
document.getElementById("adminCloseBtn").addEventListener("click", hideAdmin);
document.getElementById("adminLogoutBtn").addEventListener("click", () => {
  setSession(false);
  hideAdmin();
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
});

/* ESC */
document.addEventListener("keydown", (e) => {
  if(e.key !== "Escape") return;
  if(!adminModal.classList.contains("hidden")) hideAdmin();
  else if(!loginModal.classList.contains("hidden")) hideLogin();
});

/* =========================
   Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†: Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù + Excel Ø´Ù‡Ø±ÙŠ
========================= */
const adminTable = document.getElementById("adminTable");
const excelFile = document.getElementById("excelFile");
const clearDataBtn = document.getElementById("clearDataBtn");

const formTitle = document.getElementById("formTitle");
const formHint = document.getElementById("formHint");
const f_pharmacy = document.getElementById("f_pharmacy");
const f_name = document.getElementById("f_name");
const f_address = document.getElementById("f_address");
const f_phone = document.getElementById("f_phone");
const f_open = document.getElementById("f_open");
const f_openAmpm = document.getElementById("f_openAmpm");
const f_close = document.getElementById("f_close");
const f_closeAmpm = document.getElementById("f_closeAmpm");
const saveBtn = document.getElementById("saveBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");

let editingId = null;

function resetForm(){
  editingId = null;
  formTitle.textContent = "Ø¥Ø¶Ø§ÙØ© ØµÙŠØ¯Ù„ÙŠØ©";
  formHint.textContent = "";
  f_pharmacy.value = "";
  f_name.value = "";
  f_address.value = "";
  f_phone.value = "";
  f_open.value = "";
  f_openAmpm.value = "AM";
  f_close.value = "";
  f_closeAmpm.value = "PM";
}
cancelEditBtn.addEventListener("click", () => {
  resetForm();
  toast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
});

function drawAdminTable(){
  const rows = pharmacies.map(p => {
    const openNow = isOpenNow(p);
    const badge = openNow ? `<span class="open">Ù…ÙØªÙˆØ­Ø©</span>` : `<span class="closed">Ù…ØºÙ„Ù‚Ø©</span>`;
    return `
      <tr>
        <td>${escapeHtml(p.pharmacy)}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${escapeHtml(p.address)}</td>
        <td>${escapeHtml(p.phone)}</td>
        <td>${escapeHtml(p.open)} ${escapeHtml(p.openAmpm)}<br>${escapeHtml(p.close)} ${escapeHtml(p.closeAmpm)}</td>
        <td>${badge}</td>
        <td>
          <div class="tblBtns">
            <button class="btn small primary" data-act="edit" data-id="${escapeHtml(p.id)}" type="button">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn small danger" data-act="del" data-id="${escapeHtml(p.id)}" type="button">Ø­Ø°Ù</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  adminTable.innerHTML = `
    <tr>
      <th>Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</th>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
      <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
      <th>Ø§Ù„Ø¯ÙˆØ§Ù…</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
    ${rows || `<tr><td colspan="7" style="color:var(--muted);padding:14px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>`}
  `;
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙÙˆÙŠØ¶ ÙˆØ§Ø­Ø¯ + ÙØ­Øµ ÙˆØ¬ÙˆØ¯ ID + Ø¥Ø¹Ø§Ø¯Ø© Ø±Ù†Ø¯Ø± Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© */
adminTable.addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-act]");
  if(!btn) return;

  const act = btn.dataset.act;
  const id = btn.dataset.id;

  const idx = pharmacies.findIndex(x => x.id === id);
  if(idx === -1){
    toast("Ø­Ø¯Ø« Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„");
    drawAdminTable();
    return;
  }
  const p = pharmacies[idx];

  if(act === "edit"){
    editingId = id;
    formTitle.textContent = "ØªØ¹Ø¯ÙŠÙ„ ØµÙŠØ¯Ù„ÙŠØ©";
    formHint.textContent = "Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸.";
    f_pharmacy.value = p.pharmacy;
    f_name.value = p.name;
    f_address.value = p.address;
    f_phone.value = p.phone;
    f_open.value = p.open;
    f_openAmpm.value = normalizeAmpm(p.openAmpm);
    f_close.value = p.close;
    f_closeAmpm.value = normalizeAmpm(p.closeAmpm);
    toast("ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø§Ù‡Ø²");
  }

  if(act === "del"){
    const ok = confirm("Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù Ù‡Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©ØŸ");
    if(!ok) return;
    pharmacies.splice(idx, 1);
    saveData(pharmacies);
    drawAdminTable();
    if(editingId === id) resetForm();
    toast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
  }
});

saveBtn.addEventListener("click", () => {
  const pharmacy = String(f_pharmacy.value).trim();
  const name = String(f_name.value).trim();
  const address = String(f_address.value).trim();
  const phone = String(f_phone.value).trim();
  const open = normalizeTime(f_open.value);
  const close = normalizeTime(f_close.value);
  const openAmpm = normalizeAmpm(f_openAmpm.value);
  const closeAmpm = normalizeAmpm(f_closeAmpm.value);

  if(!pharmacy){
    formHint.textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©.";
    return;
  }
  if(!open || !close){
    formHint.textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„ 10:00) ÙˆØ¨Ù†Ø¸Ø§Ù… 12 Ø³Ø§Ø¹Ø©.";
    return;
  }

  const obj = {
    id: editingId || uid(),
    pharmacy, name, address, phone,
    open, openAmpm, close, closeAmpm
  };

  if(editingId){
    const idx = pharmacies.findIndex(x => x.id === editingId);
    if(idx === -1){
      // Ø¥Ø°Ø§ Ø­ØµÙ„ Ø®Ù„Ù„ Ø¨Ø§Ù„Ù€ idØŒ Ù†ÙˆÙ‚Ù ÙˆÙ†Ø±Ø¬Ø¹ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¢Ù…Ù†
      editingId = null;
      formHint.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
      drawAdminTable();
      return;
    }
    pharmacies[idx] = obj;
    toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…");
  }else{
    pharmacies.unshift(obj);
    toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…");
  }

  saveData(pharmacies);
  drawAdminTable();
  resetForm();
});

/* Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
clearDataBtn.addEventListener("click", () => {
  const ok = confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ");
  if(!ok) return;
  pharmacies = [];
  saveData(pharmacies);
  drawAdminTable();
  resetForm();
  toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„");
});

/* Excel upload Ø´Ù‡Ø±ÙŠ: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„ */
excelFile.addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if(!file) return;

  try{
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, {type:"array"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:""});

    const mapped = rows.map(r => {
      const pharmacy =
        String(r.pharmacy ?? "").trim() ||
        String(r["Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©"] ?? "").trim();

      const name =
        String(r.name ?? "").trim() ||
        String(r["Ø§Ù„Ø§Ø³Ù…"] ?? "").trim();

      const address =
        String(r.address ?? "").trim() ||
        String(r["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] ?? "").trim();

      const phone =
        String(r.phone ?? "").trim() ||
        String(r["Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"] ?? "").trim();

      const open = normalizeTime(r.open ?? r["ÙØªØ­"] ?? "");
      const openAmpm = normalizeAmpm(r.openAmpm ?? r["ÙØªØ­ AM/PM"] ?? r["AM/PM ÙØªØ­"] ?? "");

      const close = normalizeTime(r.close ?? r["Ø¥ØºÙ„Ø§Ù‚"] ?? r["Ø§ØºÙ„Ø§Ù‚"] ?? "");
      const closeAmpm = normalizeAmpm(r.closeAmpm ?? r["Ø¥ØºÙ„Ø§Ù‚ AM/PM"] ?? r["AM/PM Ø¥ØºÙ„Ø§Ù‚"] ?? r["AM/PM Ø§ØºÙ„Ø§Ù‚"] ?? "");

      return {
        id: uid(),
        pharmacy, name, address, phone,
        open: open || "",
        openAmpm,
        close: close || "",
        closeAmpm
      };
    }).filter(x => x.pharmacy && x.open && x.close);

    pharmacies = mapped; // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„
    saveData(pharmacies);
    drawAdminTable();
    resetForm();
    toast(`ØªÙ… Ø±ÙØ¹ Excel âœ… (${pharmacies.length})`);
    alert(`ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…\nØ¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${pharmacies.length}\n(ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)`);
  }catch(err){
    console.error(err);
    alert("ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ .xlsx ÙˆØ£Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØµØ­ÙŠØ­Ø© ÙˆØ§Ù„ÙˆÙ‚Øª Ø¨ØµÙŠØºØ© 12 Ø³Ø§Ø¹Ø©.");
  }finally{
    excelFile.value = "";
  }
});

/* =========================
   Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
========================= */
(function init(){
  pharmacies = loadData();

  // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ Ù…Ø«Ø§Ù„ÙŠÙ† (ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡Ù… Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†)
  if(pharmacies.length === 0){
    pharmacies = [
      {
        id: uid(),
        pharmacy: "ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø´ÙØ§Ø¡",
        name: "Ø¯. Ø£Ø­Ù…Ø¯",
        address: "Ø¹Ø§Ù…ÙˆØ¯Ø§ - Ø§Ù„Ù…Ø±ÙƒØ²",
        phone: "09xxxxxxxx",
        open: "10:00", openAmpm:"AM",
        close: "03:00", closeAmpm:"PM",
      },
      {
        id: uid(),
        pharmacy: "ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø±Ø­Ù…Ø©",
        name: "Ø¯. Ù…Ø­Ù…Ø¯",
        address: "Ø¹Ø§Ù…ÙˆØ¯Ø§ - Ø§Ù„Ø­ÙŠ Ø§Ù„Ø´Ø±Ù‚ÙŠ",
        phone: "09xxxxxxxx",
        open: "08:00", openAmpm:"PM",
        close: "06:00", closeAmpm:"AM",
      }
    ];
    saveData(pharmacies);
  }

  renderPublic();

  // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø±Ù†Ø¯Ø±
  const loading = document.getElementById("loading");
  requestAnimationFrame(() => {
    loading.classList.add("hide");
    setTimeout(() => loading.style.display = "none", 260);
  });
})();
</script>
</body>
</html>
