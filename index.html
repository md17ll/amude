<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙÙŠ Ø¹Ø§Ù…ÙˆØ¯Ø§</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
:root{
  --green:#1f9d6a;
  --green-dark:#167a52;
  --bg:#f3faf6;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --line:#d1fae5;
  --danger:#b42318;
  --shadow:0 10px 26px rgba(0,0,0,.08);
}
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:var(--bg)}
.hidden{display:none!important}

/* Loading */
#loading{
  position:fixed;inset:0;
  background:linear-gradient(135deg,var(--green),var(--green-dark));
  color:#fff;
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;z-index:9999
}
#loading .pill{font-size:46px}
#loading .msg{margin-top:10px;text-align:center;line-height:1.7}

/* Toast */
#toast{
  position:fixed;top:14px;left:50%;
  transform:translateX(-50%);
  background:#111827;color:#fff;
  padding:10px 14px;border-radius:12px;
  font-size:13px;opacity:0;pointer-events:none;
  transition:.2s;z-index:20000
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(2px)}

/* Public */
#publicWrapper{max-width:760px;margin:auto;padding:18px 16px 110px}
.topbar{
  display:flex;
  align-items:center;
  justify-content:flex-start; /* RTL: ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
  margin-bottom:8px;
}
#dateBox{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:12px;
  background:#fff;
  border:1px solid var(--line);
  box-shadow:0 6px 16px rgba(0,0,0,.06);
  color:var(--green-dark);
  font-weight:900;
  font-size:13px;
  user-select:none;
}
#dateBox .mut{color:var(--muted);font-weight:700}

.main-title{text-align:center;font-size:28px;color:var(--green-dark);font-weight:900;margin:8px 0 14px}
.search input{width:100%;padding:14px;border-radius:14px;border:1px solid var(--line);outline:none}

.filters{display:flex;gap:10px;margin-top:14px}
.filters button{
  flex:1;padding:10px;border-radius:12px;
  border:1px solid var(--line);background:#fff;
  cursor:pointer;
  transition:transform .08s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
}
.filters button:active{transform:scale(.98)}
.filters button.active{
  background:var(--green);color:#fff;font-weight:900;
  box-shadow:0 8px 18px rgba(31,157,106,.28);
}

.section-title{font-size:18px;margin:18px 0 12px;color:var(--green-dark);font-weight:900}

/* Cards */
.card{
  background:#fff;border-radius:18px;padding:16px;
  margin-bottom:14px;box-shadow:var(--shadow)
}
.card-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}

/* âœ… status badge as RECTANGLE */
.badge{
  padding:7px 12px;
  border-radius:8px;     /* Ù…Ø³ØªØ·ÙŠÙ„ Ù…Ø±ØªØ¨ */
  font-size:13px;
  font-weight:900;
  white-space:nowrap;
  border:1px solid transparent;
}
.open{background:#e6f7ef;color:var(--green-dark);border-color:rgba(22,122,82,.18)}
.closed{background:#fdeaea;color:var(--danger);border-color:rgba(180,35,24,.18)}

.meta{font-size:14px;color:var(--muted);margin-top:4px;line-height:1.6}
.empty{text-align:center;color:var(--muted);padding:20px;background:#fff;border:1px dashed rgba(22,122,82,.22);border-radius:18px}

/* Lock */
#lockBtn{
  position:fixed;bottom:18px;left:18px;
  background:transparent;border:0;font-size:22px;
  cursor:pointer;opacity:.35
}
#lockBtn:hover{opacity:.8}

/* Modal */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:flex;align-items:center;justify-content:center;
  z-index:10000;padding:14px
}
.box{
  background:#fff;border-radius:18px;
  width:100%;max-width:1100px;
  box-shadow:0 16px 40px rgba(0,0,0,.25);
  overflow:hidden
}
.boxHeader{
  padding:14px 16px;
  background:linear-gradient(135deg,var(--green),var(--green-dark));
  color:#fff;display:flex;justify-content:space-between;align-items:center;gap:10px
}
.hBtns{display:flex;gap:10px;flex-wrap:wrap}
.hBtns button{
  background:transparent;border:0;color:#fff;
  cursor:pointer;font-size:13px;opacity:.85
}
.hBtns button:hover{opacity:1}
.boxBody{padding:16px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}

.panel{
  background:#fff;border:1px solid var(--line);
  border-radius:16px;padding:14px
}
.panel h3{margin:0 0 10px;color:var(--green-dark);font-weight:900}
.hint{color:var(--muted);font-size:12px;line-height:1.6}

input,select{
  width:100%;padding:10px;border-radius:12px;
  border:1px solid var(--line);margin-bottom:8px;outline:none
}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row > *{flex:1;min-width:140px}

.btn{
  padding:10px;border-radius:12px;
  border:1px solid var(--line);cursor:pointer;background:#fff
}
.btn.primary{background:var(--green);color:#fff;font-weight:900;border-color:var(--green)}
.btn.danger{color:var(--danger);border-color:rgba(180,35,24,.25)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--line);padding:8px;text-align:center;font-size:13px;vertical-align:top}
th{background:#eafaf2}
.small{padding:7px 10px;border-radius:10px;font-size:12px}
</style>
</head>

<body>

<div id="loading">
  <div class="pill">ğŸ’Š</div>
  <div class="msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª...<br>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
</div>

<div id="toast"></div>

<div id="publicWrapper">
  <div class="topbar">
    <div id="dateBox"></div>
  </div>

  <h1 class="main-title">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙÙŠ Ø¹Ø§Ù…ÙˆØ¯Ø§</h1>

  <div class="search">
    <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙŠØ¯Ù„ÙŠØ©">
  </div>

  <div class="filters" id="filters">
    <button class="active" data-f="open">Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†</button>
    <button data-f="closed">Ù…ØºÙ„Ù‚Ø© Ø§Ù„Ø¢Ù†</button>
    <button data-f="all">Ø§Ù„ÙƒÙ„</button>
  </div>

  <div class="section-title" id="todayTitle"></div>
  <div id="list"></div>
</div>

<button id="lockBtn" title="Ù‚Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù†">ğŸ”’</button>

<!-- Login -->
<div class="modal hidden" id="loginModal">
  <div class="box" style="max-width:420px">
    <div class="boxHeader">
      <span style="font-weight:900">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</span>
      <div class="hBtns"><button type="button" onclick="closeLogin()">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
    <div class="boxBody">
      <input id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="username">
      <input id="loginPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="current-password">
      <button class="btn primary" type="button" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
      <div id="loginErr" class="hidden" style="color:var(--danger);margin-top:8px">Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
    </div>
  </div>
</div>

<!-- Admin -->
<div class="modal hidden" id="adminModal">
  <div class="box">
    <div class="boxHeader">
      <span style="font-weight:900">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª</span>
      <div class="hBtns">
        <button type="button" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        <button type="button" onclick="closeAdmin()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <div class="boxBody grid">
      <!-- Left -->
      <div class="panel">
        <h3>Ø±ÙØ¹ Excel Ø´Ù‡Ø±ÙŠÙ‹Ø§ (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„)</h3>
        <input type="file" id="excelFile" accept=".xlsx,.xls">
        <div class="row" style="margin-top:6px">
          <button class="btn danger" type="button" onclick="clearAll()">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>

        <div class="hint" style="margin-top:10px">
          Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Excel:<br>
          <b>pharmacy</b>, <b>address</b>, <b>phone</b>, <b>duty_day</b>, <b>open</b>, <b>open_ampm</b>, <b>close</b>, <b>close_ampm</b><br>
          Ø£Ùˆ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ:<br>
          <b>Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</b>, <b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</b>, <b>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</b>, <b>ÙŠÙˆÙ… Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</b>, <b>ÙØªØ­</b>, <b>ÙØªØ­ AM/PM</b>, <b>Ø¥ØºÙ„Ø§Ù‚</b>, <b>Ø¥ØºÙ„Ø§Ù‚ AM/PM</b><br>
          Ù…Ø«Ø§Ù„: open = 10:00 Ùˆ open_ampm = AM
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

        <h3>Ø¥Ø¶Ø§ÙØ© ØµÙŠØ¯Ù„ÙŠØ©</h3>
        <input id="f_pharmacy" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©">
        <input id="f_address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <input id="f_phone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">

        <select id="f_duty_day" style="margin-top:2px">
          <option value="">Ø§Ø®ØªØ± ÙŠÙˆÙ… Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</option>
          <option>Ø§Ù„Ø³Ø¨Øª</option>
          <option>Ø§Ù„Ø£Ø­Ø¯</option>
          <option>Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</option>
          <option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
          <option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
          <option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
          <option>Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
        </select>

        <div class="row">
          <input id="f_open" placeholder="Ø³Ø§Ø¹Ø© Ø§Ù„ÙØªØ­ 10:00">
          <select id="f_open_ampm"><option>AM</option><option>PM</option></select>
        </div>
        <div class="row">
          <input id="f_close" placeholder="Ø³Ø§Ø¹Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ 03:00">
          <select id="f_close_ampm"><option>AM</option><option selected>PM</option></select>
        </div>

        <button class="btn primary" id="saveBtn" type="button" onclick="addPharmacy()">Ø­ÙØ¸</button>
      </div>

      <!-- Right -->
      <div class="panel">
        <h3>Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª (ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…)</h3>
        <div style="overflow:auto">
          <table id="adminTable"></table>
        </div>
        <div class="hint" style="margin-top:10px">
          Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø²ÙˆØ§Ø± ÙŠØ¹Ø±Ø¶ <b>Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·</b>.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== Supabase ===================== */
const SUPABASE_URL="https://wvezqetliqbotmkybezj.supabase.co";
const API_KEY="sb_publishable_APdaO2PyWThd6ISkSdpR1Q_yfTNJO8y";
const TABLE="pharmacies";

/* Admin */
const ADMIN_USER="amuda.br";
const ADMIN_PASS="@Bb300300";

let pharmacies=[], filter="open";

/* Toast */
const toastEl=document.getElementById("toast");
let tmr=null;
function toast(msg){
  toastEl.textContent=msg;
  toastEl.classList.add("show");
  clearTimeout(tmr);
  tmr=setTimeout(()=>toastEl.classList.remove("show"),1800);
}

/* Helpers */
function esc(s){return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}
function normAmpm(v){v=String(v??"").trim().toUpperCase();return v==="PM"?"PM":"AM"}
function normTime(v){
  v=String(v??"").trim();
  const m=v.match(/^(\d{1,2})(?::(\d{1,2}))?$/);
  if(!m) return "";
  let hh=+m[1], mm=+(m[2]??0);
  if(hh<1||hh>12||mm<0||mm>59) return "";
  return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
}
function normalizeDay(v){
  v=String(v??"").trim();
  // Ù†Ù‚Ø¨Ù„ Ø£ÙƒØ«Ø± Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø¨Ø³ÙŠØ·Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  const map={
    "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†":"Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†",
    "Ø§Ù„Ø§Ø«Ù†ÙŠÙ† ":"Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†",
    "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†\t":"Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†",
    "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†":"Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†",
    "Ø§Ù„Ø§Ø­Ø¯":"Ø§Ù„Ø£Ø­Ø¯",
    "Ø§Ù„Ø£Ø­Ø¯":"Ø§Ù„Ø£Ø­Ø¯",
    "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡":"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡",
    "Ø§Ù„Ø§Ø±Ø¨Ø¹Ø§Ø¡":"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡",
    "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡":"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡",
    "Ø§Ù„Ø®Ù…ÙŠØ³":"Ø§Ù„Ø®Ù…ÙŠØ³",
    "Ø§Ù„Ø¬Ù…Ø¹Ø©":"Ø§Ù„Ø¬Ù…Ø¹Ø©",
    "Ø§Ù„Ø³Ø¨Øª":"Ø§Ù„Ø³Ø¨Øª"
  };
  return map[v] || v;
}

/* Arabic date */
function getTodayArabic(){
  const d=new Date();
  const days=["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
  const dayName=days[d.getDay()];
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yyyy=d.getFullYear();
  return { dayName, dateText:`${dd}/${mm}/${yyyy}` };
}

/* time */
function toMin(t,a){
  const parts=String(t).split(":");
  if(parts.length!==2) return null;
  let h=+parts[0], m=+parts[1];
  if(!Number.isFinite(h)||!Number.isFinite(m)) return null;
  a=String(a).toUpperCase();
  if(a==="PM" && h!==12) h+=12;
  if(a==="AM" && h===12) h=0;
  return h*60+m;
}
function isOpen(p){
  const n=new Date();
  const now=n.getHours()*60+n.getMinutes();
  const o=toMin(p.open,p.open_ampm);
  const c=toMin(p.close,p.close_ampm);
  if(o===null||c===null) return false;
  return c<o ? (now>=o||now<c) : (now>=o && now<c);
}

/* REST helper */
async function sbFetch(path, opt={}){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{
    ...opt,
    headers:{
      apikey:API_KEY,
      Authorization:`Bearer ${API_KEY}`,
      ...(opt.headers||{})
    }
  });
  let text = "";
  try{ text = await res.text(); }catch(_){}
  let data = null;
  try{ data = text ? JSON.parse(text) : null; }catch(_){ data = text; }
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.details)) ? (data.message||data.error||data.details) : `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

/* render public (TODAY ONLY) */
function render(){
  const today = getTodayArabic();
  const todayName = today.dayName;

  document.getElementById("todayTitle").textContent = `Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„ÙŠÙˆÙ… â€” ${todayName}`;

  const q=searchInput.value.toLowerCase().trim();

  // âœ… ÙÙ„ØªØ±Ø©: Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·
  let items = pharmacies
    .filter(p => normalizeDay(p.duty_day) === todayName)
    .filter(p => String(p.pharmacy??"").toLowerCase().includes(q))
    .map(p=>({...p,_o:isOpen(p)}));

  if(filter==="open") items=items.filter(p=>p._o);
  if(filter==="closed") items=items.filter(p=>!p._o);

  // ØªØ±ØªÙŠØ¨: Ø§Ù„Ù…ÙØªÙˆØ­ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø§Ø³Ù…
  items.sort((a,b)=> (b._o - a._o) || String(a.pharmacy||"").localeCompare(String(b.pharmacy||""),"ar"));

  list.innerHTML = items.length ? items.map(p=>`
    <div class="card">
      <div class="card-top">
        <div>
          <b>${esc(p.pharmacy)}</b>
          <div class="meta">ğŸ“ ${esc(p.address||"â€”")}</div>
          <div class="meta">ğŸ“ ${esc(p.phone||"â€”")}</div>
          <div class="meta">ğŸ—“ï¸ ${esc(normalizeDay(p.duty_day)||"â€”")}</div>
        </div>
        <span class="badge ${p._o?"open":"closed"}">${p._o?"Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†":"Ù…ØºÙ„Ù‚Ø© Ø§Ù„Ø¢Ù†"}</span>
      </div>
      <div class="meta" style="margin-top:8px">â° ${esc(p.open)} ${esc(p.open_ampm)} â€” ${esc(p.close)} ${esc(p.close_ampm)}</div>
    </div>
  `).join("") : `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙŠØ¯Ù„ÙŠØ§Øª Ù…Ù†Ø§ÙˆØ¨Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</div>`;
}

/* load */
async function load(){
  try{
    const data = await sbFetch(`${TABLE}?select=*`);
    pharmacies = Array.isArray(data) ? data : [];
  }catch(e){
    pharmacies=[];
    toast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase");
    console.error(e);
  }

  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²Ø§ÙˆÙŠØ©
  const t=getTodayArabic();
  document.getElementById("dateBox").innerHTML = `ğŸ“… <span>${t.dayName}</span> <span class="mut">${t.dateText}</span>`;

  document.getElementById("loading").style.display="none";
  render();
  drawAdmin();
}

/* filters */
filters.onclick=e=>{
  const b=e.target.closest("button[data-f]");
  if(!b) return;
  filters.querySelectorAll("button").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  filter=b.dataset.f;
  render();
};
searchInput.oninput=render;

/* auto refresh open/close every minute (public only) */
setInterval(()=> {
  if(!document.getElementById("adminModal").classList.contains("hidden")) return;
  render();
}, 60000);

/* login/admin */
lockBtn.onclick=()=>loginModal.classList.remove("hidden");
function closeLogin(){loginModal.classList.add("hidden")}
function login(){
  loginErr.classList.add("hidden");
  if(loginUser.value===ADMIN_USER && loginPass.value===ADMIN_PASS){
    loginModal.classList.add("hidden");
    publicWrapper.classList.add("hidden");
    adminModal.classList.remove("hidden");
    toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…");
  }else{
    loginErr.classList.remove("hidden");
  }
}
function logout(){
  adminModal.classList.add("hidden");
  publicWrapper.classList.remove("hidden");
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
  render();
}
function closeAdmin(){
  adminModal.classList.add("hidden");
  publicWrapper.classList.remove("hidden");
  render();
}

/* admin table (ALL DAYS) */
function drawAdmin(){
  adminTable.innerHTML =
    `<tr>
      <th>Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</th>
      <th>Ø§Ù„ÙŠÙˆÙ…</th>
      <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
      <th>Ø§Ù„Ø¯ÙˆØ§Ù…</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>Ø­Ø°Ù</th>
    </tr>` +
    pharmacies.map(p=>{
      const st=isOpen(p);
      return `<tr>
        <td>${esc(p.pharmacy||"")}</td>
        <td>${esc(normalizeDay(p.duty_day)||"â€”")}</td>
        <td>${esc(p.phone||"")}</td>
        <td>${esc(p.open||"")} ${esc(p.open_ampm||"")}<br>${esc(p.close||"")} ${esc(p.close_ampm||"")}</td>
        <td><span class="badge ${st?"open":"closed"}">${st?"Ù…ÙØªÙˆØ­Ø©":"Ù…ØºÙ„Ù‚Ø©"}</span></td>
        <td><button class="btn danger small" type="button" onclick="delPh('${esc(p.id)}')">Ø­Ø°Ù</button></td>
      </tr>`;
    }).join("");
}

async function delPh(id){
  try{
    await sbFetch(`${TABLE}?id=eq.${encodeURIComponent(id)}`,{method:"DELETE"});
    toast("ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…");
    await load();
  }catch(e){
    toast("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
    console.error(e);
    alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù:\n" + e.message);
  }
}

/* add pharmacy */
async function addPharmacy(){
  const pharmacy = f_pharmacy.value.trim();
  const address  = f_address.value.trim();
  const phone    = f_phone.value.trim();
  const duty_day = normalizeDay(f_duty_day.value);
  const open     = normTime(f_open.value);
  const close    = normTime(f_close.value);
  const open_ampm = normAmpm(f_open_ampm.value);
  const close_ampm = normAmpm(f_close_ampm.value);

  if(!pharmacy){ toast("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©"); return; }
  if(!duty_day){ toast("Ø§Ø®ØªØ± ÙŠÙˆÙ… Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©"); return; }
  if(!open || !close){ toast("Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª ØµØ­ÙŠØ­ 12 Ø³Ø§Ø¹Ø© Ù…Ø«Ù„ 10:00"); return; }

  try{
    await sbFetch(`${TABLE}`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Prefer":"return=representation"
      },
      body:JSON.stringify({ pharmacy,address,phone,duty_day,open,open_ampm,close,close_ampm })
    });

    toast("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…");
    f_pharmacy.value=""; f_address.value=""; f_phone.value="";
    f_duty_day.value="";
    f_open.value=""; f_close.value="";

    await load();
  }catch(e){
    console.error(e);
    toast("Ø§Ù„Ø­ÙØ¸ ÙØ´Ù„");
    alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸:\n" + e.message);
  }
}

/* clear all */
async function clearAll(){
  const ok = confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ù…ØªØ£ÙƒØ¯ØŸ");
  if(!ok) return;
  try{
    await sbFetch(`${TABLE}?id=neq.0`,{method:"DELETE"});
    toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ âœ…");
    await load();
  }catch(e){
    console.error(e);
    toast("ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­");
    alert("ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„:\n" + e.message);
  }
}

/* Excel replace */
excelFile.onchange=async e=>{
  const file=e.target.files && e.target.files[0];
  if(!file) return;

  try{
    const buf=await file.arrayBuffer();
    const wb=XLSX.read(buf,{type:"array"});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{defval:""});

    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„
    await sbFetch(`${TABLE}?id=neq.0`,{method:"DELETE"});

    for(const r of rows){
      const obj={
        pharmacy:String(r.pharmacy??r["Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©"]??"").trim(),
        address:String(r.address??r["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"]??"").trim(),
        phone:String(r.phone??r["Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"]??"").trim(),
        duty_day: normalizeDay(r.duty_day ?? r["ÙŠÙˆÙ… Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©"] ?? ""),
        open:normTime(r.open??r["ÙØªØ­"]??""),
        open_ampm:normAmpm(r.open_ampm??r.openAmpm??r["ÙØªØ­ AM/PM"]??""),
        close:normTime(r.close??r["Ø¥ØºÙ„Ø§Ù‚"]??r["Ø§ØºÙ„Ø§Ù‚"]??""),
        close_ampm:normAmpm(r.close_ampm??r.closeAmpm??r["Ø¥ØºÙ„Ø§Ù‚ AM/PM"]??"")
      };

      if(!obj.pharmacy || !obj.duty_day || !obj.open || !obj.close) continue;

      await sbFetch(`${TABLE}`,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Prefer":"return=representation"
        },
        body:JSON.stringify(obj)
      });
    }

    toast("ØªÙ… Ø±ÙØ¹ Excel âœ…");
    await load();
  }catch(err){
    console.error(err);
    alert("ÙØ´Ù„ Ø±ÙØ¹ Excel:\n" + err.message);
  }finally{
    excelFile.value="";
  }
};

load();
</script>
</body>
</html>
```î¨0î¨‚
