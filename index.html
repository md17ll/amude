<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙÙŠ Ø¹Ø§Ù…ÙˆØ¯Ø§</title>

  <style>
    :root{
      --green:#1f9d6a;
      --green-dark:#167a52;
      --bg:#f3faf6;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#d1fae5;
      --danger:#b42318;
      --shadow:0 10px 26px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .hidden{display:none !important}

    /* ===== Loading Overlay ===== */
    #loading{
      position:fixed; inset:0;
      background:linear-gradient(135deg,var(--green),var(--green-dark));
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      flex-direction:column;
      z-index:9999;
      transition:opacity .25s ease;
    }
    #loading.hide{opacity:0; pointer-events:none}
    #loading .pill{font-size:44px}
    #loading .msg{margin-top:10px; opacity:.95; text-align:center; line-height:1.6}

    /* ===== Layout ===== */
    #publicWrapper{
      max-width:760px;
      margin:auto;
      padding:18px 16px 110px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .todayBadge{
      font-size:13px;
      background:#eafaf2;
      color:var(--green-dark);
      border:1px solid rgba(22,122,82,.18);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      box-shadow:0 6px 16px rgba(0,0,0,.05);
      white-space:nowrap;
    }

    .main-title{
      text-align:center;
      font-size:28px;
      color:var(--green-dark);
      margin:8px 0 14px;
      font-weight:900;
      letter-spacing:.2px;
      flex:1;
    }

    /* Search */
    .search input{
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--line);
      font-size:16px;
      outline:none;
      background:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.06);
    }

    /* Filters */
    .filters{
      display:flex;
      gap:10px;
      margin-top:14px;
    }
    .filters button{
      flex:1;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:14px;
      transition:transform .12s ease, background .18s ease, color .18s ease, border-color .18s ease, box-shadow .18s ease;
      user-select:none;
    }
    .filters button:active{transform:scale(.97)}
    .filters button.active{
      background:var(--green);
      color:#fff;
      border-color:var(--green);
      font-weight:900;
      box-shadow:0 6px 18px rgba(31,157,106,.22);
    }

    .section-title{
      font-size:20px;
      margin:22px 0 12px;
      color:var(--green-dark);
      font-weight:900;
    }

    /* Cards */
    .card{
      background:var(--card);
      border-radius:18px;
      padding:16px;
      margin-bottom:14px;
      box-shadow:var(--shadow);
      border:1px solid rgba(209,250,229,.35);
    }
    .card-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .card h3{
      margin:0;
      font-size:18px;
      font-weight:900;
    }
    .meta{
      font-size:14px;
      color:var(--muted);
      margin-top:6px;
      line-height:1.6;
    }

    /* Ù…Ø³ØªØ·ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø±ØªØ¨) */
    .statusRect{
      padding:7px 12px;
      border-radius:10px;
      font-size:13px;
      font-weight:900;
      white-space:nowrap;
      border:1px solid transparent;
      min-width:92px;
      text-align:center;
    }
    .statusOpen{
      background:#e6f7ef;
      color:var(--green-dark);
      border-color:rgba(22,122,82,.18);
    }
    .statusClosed{
      background:#fdeaea;
      color:var(--danger);
      border-color:rgba(180,35,24,.18);
    }

    .actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      text-decoration:none;
      font-size:14px;
    }

    /* Empty state */
    .empty{
      background:#fff;
      border:1px dashed rgba(22,122,82,.25);
      border-radius:18px;
      padding:18px;
      color:var(--muted);
      text-align:center;
      box-shadow:0 8px 22px rgba(0,0,0,.05);
    }

    /* ===== Admin lock (transparent + smaller) ===== */
    #lockBtn{
      position:fixed;
      bottom:18px;
      left:18px;
      width:34px;
      height:34px;
      border-radius:10px;
      background:transparent;
      border:0;
      padding:0;
      cursor:pointer;
      z-index:200;
      opacity:.28;
      transition:opacity .15s ease, transform .05s ease;
    }
    #lockBtn:hover{opacity:.75}
    #lockBtn:active{transform:scale(.98)}
    #lockBtn svg{width:22px;height:22px;display:block;margin:auto;fill:var(--green-dark);}

    /* ===== Modal base ===== */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
      padding:18px;
    }
    .modal.hidden{display:none}
    .box{
      width:100%;
      max-width:980px;
      background:#fff;
      border-radius:18px;
      box-shadow:0 16px 40px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .boxHeader{
      padding:14px 16px;
      background:linear-gradient(135deg,var(--green),var(--green-dark));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .boxHeader h2{margin:0;font-size:16px;font-weight:900}
    .boxHeader .hdrBtns{display:flex;gap:8px;flex-wrap:wrap}
    .hdrBtn{
      background:rgba(255,255,255,.14);
      color:#fff;
      border:1px solid rgba(255,255,255,.22);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
      transition:transform .12s ease, background .18s ease;
    }
    .hdrBtn:active{transform:scale(.97)}
    .boxBody{padding:16px}

    .loginBox{
      max-width:420px;
      width:100%;
      background:#fff;
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 16px 40px rgba(0,0,0,.25);
    }
    .loginBody{padding:16px}

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media (min-width:980px){
      .grid{grid-template-columns:1.12fr .88fr}
    }

    .panel{
      background:#fff;
      border:1px solid rgba(209,250,229,.6);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 26px rgba(0,0,0,.06);
    }
    .panel h3{margin:0 0 10px;font-size:15px;color:var(--green-dark);font-weight:900}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{flex:1; min-width:180px}
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .field input, .field select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      font-size:14px;
    }

    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:14px;
      user-select:none;
      transition:transform .12s ease, box-shadow .18s ease;
    }
    .btn:active{transform:scale(.97)}
    .btn.primary{
      background:var(--green);
      color:#fff;
      border-color:var(--green);
      font-weight:900;
      box-shadow:0 6px 18px rgba(31,157,106,.18);
    }
    .btn.danger{
      background:#fff;
      color:var(--danger);
      border-color:rgba(180,35,24,.25);
      font-weight:900;
    }
    .hint{color:var(--muted); font-size:12px; line-height:1.6; margin-top:8px}
    .err{color:var(--danger);font-size:13px;margin-top:10px;display:none}

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(209,250,229,.7);
      background:#fff;
    }
    th,td{
      border-bottom:1px solid rgba(209,250,229,.8);
      padding:9px 8px;
      font-size:13px;
      text-align:center;
      vertical-align:top;
      white-space:nowrap;
    }
    th{background:#eafaf2;color:var(--green-dark);font-weight:900}
    tr:last-child td{border-bottom:none}
    .tblBtns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .small{font-size:12px;padding:7px 10px;border-radius:10px}

    /* Toast */
    #toast{
      position:fixed;
      top:14px;
      left:50%;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:12000;
    }
    #toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(2px);
    }
  </style>

  <!-- Excel reader (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>

<body>
  <!-- Loading overlay -->
  <div id="loading">
    <div class="pill">ğŸ’Š</div>
    <div class="msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª...<br>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
  </div>

  <div id="publicWrapper">
    <div class="topbar">
      <div class="todayBadge" id="todayBadge">ğŸ“… â€”</div>
      <h1 class="main-title">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙÙŠ Ø¹Ø§Ù…ÙˆØ¯Ø§</h1>
      <div style="width:86px"></div>
    </div>

    <div class="search">
      <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙŠØ¯Ù„ÙŠØ© Ø¨Ø§Ù„Ø§Ø³Ù…" autocomplete="off" />
    </div>

    <!-- ØªØ±ØªÙŠØ¨ Ø§Ù„ÙÙ„ØªØ±Ø©: Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†ØŒ Ù…ØºÙ„Ù‚Ø© Ø§Ù„Ø¢Ù†ØŒ Ø§Ù„ÙƒÙ„ -->
    <div class="filters" id="filters">
      <button type="button" class="active" data-filter="open">Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†</button>
      <button type="button" data-filter="closed">Ù…ØºÙ„Ù‚Ø© Ø§Ù„Ø¢Ù†</button>
      <button type="button" data-filter="all">Ø§Ù„ÙƒÙ„</button>
    </div>

    <div class="section-title">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„Ø¢Ù†</div>
    <div id="list"></div>
  </div>

  <!-- Transparent small admin lock -->
  <button id="lockBtn" aria-label="Ù‚Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù†" title="Ù‚Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù†">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2zm-7-2a2 2 0 1 1 4 0v2h-4V7zm3.1 9.7-.3.3V18a.8.8 0 0 1-1.6 0v-1l-.3-.3a1.5 1.5 0 1 1 2.2 0z"/>
    </svg>
  </button>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Login modal -->
  <div class="modal hidden" id="loginModal">
    <div class="loginBox">
      <div class="boxHeader">
        <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
        <div class="hdrBtns">
          <button class="hdrBtn" id="loginCloseBtn" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
      <div class="loginBody">
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="loginUser" autocomplete="username" />
        </div>
        <div class="field" style="margin-top:10px">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="loginPass" type="password" autocomplete="current-password" />
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="loginBtn" type="button" style="flex:1;min-width:140px">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn" id="loginCancelBtn" type="button" style="flex:1;min-width:140px">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
        <div class="err" id="loginErr">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
      </div>
    </div>
  </div>

  <!-- Admin modal -->
  <div class="modal hidden" id="adminModal">
    <div class="box">
      <div class="boxHeader">
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª</h2>
        <div class="hdrBtns">
          <button class="hdrBtn" id="adminLogoutBtn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          <button class="hdrBtn" id="adminCloseBtn" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="boxBody">
        <div class="grid">
          <!-- Left: table -->
          <div class="panel">
            <h3>Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª</h3>
            <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ø£ÙŠ ØµÙŠØ¯Ù„ÙŠØ©ØŒ Ø£Ùˆ Ø±ÙØ¹ Ù…Ù„Ù Excel Ø´Ù‡Ø±ÙŠÙ‹Ø§ Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.</div>
            <div style="margin-top:12px; overflow:auto;">
              <table id="adminTable"></table>
            </div>
          </div>

          <!-- Right: actions + form -->
          <div class="panel">
            <h3>Ø±ÙØ¹ Excel Ø´Ù‡Ø±ÙŠÙ‹Ø§ (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„)</h3>
            <div class="row">
              <input id="excelFile" type="file" accept=".xlsx,.xls" class="btn" style="flex:1;min-width:220px" />
              <button class="btn danger" id="clearDataBtn" type="button" style="min-width:160px">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
            <div class="hint">
              Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Excel (Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ§Ø±ÙŠØ®):
              <br><b>pharmacy</b>, <b>address</b>, <b>phone</b>, <b>duty_date</b>, <b>open</b>, <b>open_ampm</b>, <b>close</b>, <b>close_ampm</b>
              <br>ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ®: <b>YYYY-MM-DD</b> Ù…Ø«Ù„: <b>2025-12-23</b>
              <br>Ø§Ù„ÙˆÙ‚Øª Ø¨Ù†Ø¸Ø§Ù… 12 Ø³Ø§Ø¹Ø© Ù…Ø«Ù„: <b>10:00</b> Ù…Ø¹ <b>AM</b> Ø£Ùˆ <b>PM</b>
            </div>

            <hr style="border:none;border-top:1px solid rgba(209,250,229,.9); margin:14px 0;">

            <h3 id="formTitle">Ø¥Ø¶Ø§ÙØ© ØµÙŠØ¯Ù„ÙŠØ©</h3>

            <div class="row">
              <div class="field" style="flex:1.2;min-width:240px">
                <label>Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</label>
                <input id="f_pharmacy" placeholder="Ù…Ø«Ø§Ù„: ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø´ÙØ§Ø¡" />
              </div>
              <div class="field" style="flex:1;min-width:200px">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© (YYYY-MM-DD)</label>
                <input id="f_duty_date" placeholder="2025-12-23" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field" style="flex:1.2;min-width:240px">
                <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <input id="f_address" placeholder="Ø¹Ø§Ù…ÙˆØ¯Ø§ - ..." />
              </div>
              <div class="field" style="flex:1;min-width:200px">
                <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input id="f_phone" placeholder="09xxxxxxxx" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field">
                <label>Ø³Ø§Ø¹Ø© Ø§Ù„ÙØªØ­</label>
                <input id="f_open" placeholder="10:00" />
              </div>
              <div class="field" style="min-width:120px">
                <label>AM/PM</label>
                <select id="f_openAmpm">
                  <option>AM</option>
                  <option>PM</option>
                </select>
              </div>
              <div class="field">
                <label>Ø³Ø§Ø¹Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</label>
                <input id="f_close" placeholder="03:00" />
              </div>
              <div class="field" style="min-width:120px">
                <label>AM/PM</label>
                <select id="f_closeAmpm">
                  <option>AM</option>
                  <option selected>PM</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="saveBtn" type="button" style="flex:1;min-width:160px">Ø­ÙØ¸</button>
              <button class="btn" id="cancelEditBtn" type="button" style="flex:1;min-width:160px">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            </div>

            <div class="hint" id="formHint"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Supabase Settings
========================= */
const SUPABASE_URL = "https://wvezqetliqbotmkybezj.supabase.co";
const SUPABASE_KEY = "sb_publishable_APdaO2PyWThd6ISkSdpR1Q_yfTNJO8y";
const TABLE = "pharmacies";

/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† */
const ADMIN_USER = "amuda.br";
const ADMIN_PASS = "@Bb300300";

/* =========================
   Helpers
========================= */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function normalizeAmpm(v){
  const s = String(v ?? "").trim().toUpperCase();
  return (s === "PM") ? "PM" : "AM";
}
function normalizeTime(v){
  const s = String(v ?? "").trim();
  const m = s.match(/^(\d{1,2})(?::(\d{1,2}))?$/);
  if(!m) return "";
  let hh = Number(m[1]);
  let mm = Number(m[2] ?? 0);
  if(!Number.isFinite(hh) || !Number.isFinite(mm)) return "";
  if(hh < 1 || hh > 12) return "";
  if(mm < 0 || mm > 59) return "";
  return String(hh).padStart(2,"0") + ":" + String(mm).padStart(2,"0");
}
function normalizeDate(v){
  // returns YYYY-MM-DD or ""
  if(v == null) return "";
  if(v instanceof Date && !isNaN(v.getTime())){
    const y=v.getFullYear(), m=String(v.getMonth()+1).padStart(2,"0"), d=String(v.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }
  if(typeof v === "number" && window.XLSX?.SSF?.parse_date_code){
    const dc = XLSX.SSF.parse_date_code(v);
    if(dc && dc.y && dc.m && dc.d){
      const y=dc.y, m=String(dc.m).padStart(2,"0"), d=String(dc.d).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
  }
  const s = String(v).trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m1 = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m1){
    const dd=String(m1[1]).padStart(2,"0");
    const mm=String(m1[2]).padStart(2,"0");
    const yy=m1[3];
    return `${yy}-${mm}-${dd}`;
  }
  const dt = new Date(s);
  if(!isNaN(dt.getTime())){
    const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,"0"), d=String(dt.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }
  return "";
}
function formatArabicDateLabel(iso){
  try{
    const [y,m,d]=iso.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    const days = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
    const dayName = days[dt.getDay()];
    return `ğŸ“… ${dayName} â€” ${iso}`;
  }catch(_e){
    return `ğŸ“… ${iso}`;
  }
}
function todayISO(){
  const n = new Date();
  const y=n.getFullYear(), m=String(n.getMonth()+1).padStart(2,"0"), d=String(n.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}

/* Toast */
const toastEl = document.getElementById("toast");
let toastTimer = null;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> toastEl.classList.remove("show"), 1800);
}

/* =========================
   Time Logic (12h AM/PM)
========================= */
function toMinutes(t, ampm){
  const parts = String(t).split(":");
  if(parts.length !== 2) return null;
  const h0 = Number(parts[0]);
  const m0 = Number(parts[1]);
  if(!Number.isFinite(h0) || !Number.isFinite(m0)) return null;
  let h = h0;
  const ap = String(ampm).toUpperCase();
  if(ap === "PM" && h !== 12) h += 12;
  if(ap === "AM" && h === 12) h = 0;
  return h * 60 + m0;
}
function isOpenNow(p){
  const now = new Date();
  const n = now.getHours() * 60 + now.getMinutes();
  const o = toMinutes(p.open, p.open_ampm);
  const c = toMinutes(p.close, p.close_ampm);
  if(o === null || c === null) return false;
  if(o < c) return (n >= o && n < c);
  return (n >= o || n < c);
}

/* =========================
   Supabase REST Helpers
========================= */
async function sbFetch(path, options={}){
  const headers = {
    apikey: SUPABASE_KEY,
    Authorization: `Bearer ${SUPABASE_KEY}`,
    ...options.headers
  };
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    ...options,
    headers
  });
  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error(`Supabase error ${res.status}: ${txt || res.statusText}`);
  }
  const ct = res.headers.get("content-type") || "";
  if(ct.includes("application/json")) return await res.json();
  return await res.text();
}

/* =========================
   Public UI
========================= */
let pharmacies = [];
let currentFilter = "open";
const listEl = document.getElementById("list");
const searchInput = document.getElementById("searchInput");
const publicWrapper = document.getElementById("publicWrapper");
const todayBadge = document.getElementById("todayBadge");

function renderPublic(){
  const q = searchInput.value.trim().toLowerCase();
  const tISO = todayISO();
  todayBadge.textContent = formatArabicDateLabel(tISO);

  let items = pharmacies
    .filter(p => normalizeDate(p.duty_date) === tISO)
    .filter(p => String(p.pharmacy ?? "").toLowerCase().includes(q))
    .map(p => ({...p, __open: isOpenNow(p)}));

  if(currentFilter === "open") items = items.filter(p => p.__open);
  if(currentFilter === "closed") items = items.filter(p => !p.__open);

  items.sort((a,b) => (b.__open - a.__open) || String(a.pharmacy).localeCompare(String(b.pharmacy), "ar"));

  if(items.length === 0){
    listEl.innerHTML = `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙŠØ¯Ù„ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¢Ù†.</div>`;
    return;
  }

  listEl.innerHTML = items.map(p => {
    const status = p.__open
      ? `<div class="statusRect statusOpen">Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†</div>`
      : `<div class="statusRect statusClosed">Ù…ØºÙ„Ù‚Ø© Ø§Ù„Ø¢Ù†</div>`;

    const tel = p.phone ? `<a class="chip" href="tel:${escapeHtml(p.phone)}">ğŸ“ Ø§ØªØµØ§Ù„</a>` : "";

    return `
      <div class="card">
        <div class="card-top">
          <div>
            <h3>${escapeHtml(p.pharmacy)}</h3>
            <div class="meta">ğŸ“ ${escapeHtml(p.address || "â€”")}</div>
            <div class="meta">ğŸ“ ${escapeHtml(p.phone || "â€”")}</div>
          </div>
          ${status}
        </div>
        <div class="actions">${tel}</div>
      </div>
    `;
  }).join("");
}

/* Filters */
document.getElementById("filters").addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-filter]");
  if(!btn) return;
  document.querySelectorAll("#filters button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  currentFilter = btn.dataset.filter;
  renderPublic();
});
searchInput.addEventListener("input", renderPublic);

setInterval(() => {
  if(!adminModal.classList.contains("hidden")) return;
  renderPublic();
}, 60 * 1000);

/* =========================
   Admin Modals
========================= */
const lockBtn = document.getElementById("lockBtn");
const loginModal = document.getElementById("loginModal");
const adminModal = document.getElementById("adminModal");
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginErr = document.getElementById("loginErr");

const ADMIN_SESSION_KEY = "amuda_admin_session_v3_date";

function setSession(on){
  if(on) sessionStorage.setItem(ADMIN_SESSION_KEY, "1");
  else sessionStorage.removeItem(ADMIN_SESSION_KEY);
}
function isAuthed(){
  return sessionStorage.getItem(ADMIN_SESSION_KEY) === "1";
}
function showLogin(){
  loginErr.style.display = "none";
  loginUser.value = "";
  loginPass.value = "";
  loginModal.classList.remove("hidden");
  setTimeout(() => loginUser.focus(), 0);
}
function hideLogin(){
  loginModal.classList.add("hidden");
}
function showAdmin(){
  publicWrapper.classList.add("hidden");
  adminModal.classList.remove("hidden");
  resetForm();
  drawAdminTable();
}
function hideAdmin(){
  adminModal.classList.add("hidden");
  publicWrapper.classList.remove("hidden");
  renderPublic();
}

lockBtn.addEventListener("click", () => {
  if(isAuthed()) showAdmin();
  else showLogin();
});

document.getElementById("loginCloseBtn").addEventListener("click", hideLogin);
document.getElementById("loginCancelBtn").addEventListener("click", hideLogin);
document.getElementById("loginBtn").addEventListener("click", () => {
  const u = loginUser.value.trim();
  const p = loginPass.value;
  if(u === ADMIN_USER && p === ADMIN_PASS){
    setSession(true);
    hideLogin();
    showAdmin();
    toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…");
  }else{
    loginErr.style.display = "block";
  }
});

document.getElementById("adminCloseBtn").addEventListener("click", hideAdmin);
document.getElementById("adminLogoutBtn").addEventListener("click", () => {
  setSession(false);
  hideAdmin();
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
});

document.addEventListener("keydown", (e) => {
  if(e.key !== "Escape") return;
  if(!adminModal.classList.contains("hidden")) hideAdmin();
  else if(!loginModal.classList.contains("hidden")) hideLogin();
});

/* =========================
   Admin: Add / Edit / Delete + Excel replace
========================= */
const adminTable = document.getElementById("adminTable");
const excelFile = document.getElementById("excelFile");
const clearDataBtn = document.getElementById("clearDataBtn");

const formTitle = document.getElementById("formTitle");
const formHint = document.getElementById("formHint");
const f_pharmacy = document.getElementById("f_pharmacy");
const f_duty_date = document.getElementById("f_duty_date");
const f_address = document.getElementById("f_address");
const f_phone = document.getElementById("f_phone");
const f_open = document.getElementById("f_open");
const f_openAmpm = document.getElementById("f_openAmpm");
const f_close = document.getElementById("f_close");
const f_closeAmpm = document.getElementById("f_closeAmpm");
const saveBtn = document.getElementById("saveBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");

let editingId = null;

function resetForm(){
  editingId = null;
  formTitle.textContent = "Ø¥Ø¶Ø§ÙØ© ØµÙŠØ¯Ù„ÙŠØ©";
  formHint.textContent = "";
  f_pharmacy.value = "";
  f_duty_date.value = "";
  f_address.value = "";
  f_phone.value = "";
  f_open.value = "";
  f_openAmpm.value = "AM";
  f_close.value = "";
  f_closeAmpm.value = "PM";
  saveBtn.textContent = "Ø­ÙØ¸";
}
cancelEditBtn.addEventListener("click", () => {
  resetForm();
  toast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
});

function drawAdminTable(){
  const rowsSorted = [...pharmacies].sort((a,b) => {
    const da = normalizeDate(a.duty_date) || "";
    const db = normalizeDate(b.duty_date) || "";
    if(da !== db) return da.localeCompare(db);
    return String(a.pharmacy||"").localeCompare(String(b.pharmacy||""), "ar");
  });

  const rows = rowsSorted.map(p => {
    const duty = normalizeDate(p.duty_date) || "â€”";
    const openNow = (normalizeDate(p.duty_date) === todayISO()) ? isOpenNow(p) : false;
    const state = openNow ? `<span style="color:var(--green-dark);font-weight:900">Ù…ÙØªÙˆØ­Ø©</span>` : `<span style="color:var(--danger);font-weight:900">Ù…ØºÙ„Ù‚Ø©</span>`;
    return `
      <tr>
        <td>${escapeHtml(p.pharmacy)}</td>
        <td>${escapeHtml(duty)}</td>
        <td>${escapeHtml(p.address || "")}</td>
        <td>${escapeHtml(p.phone || "")}</td>
        <td>${escapeHtml(p.open || "")} ${escapeHtml(normalizeAmpm(p.open_ampm))}<br>${escapeHtml(p.close || "")} ${escapeHtml(normalizeAmpm(p.close_ampm))}</td>
        <td>${state}</td>
        <td>
          <div class="tblBtns">
            <button class="btn small primary" data-act="edit" data-id="${escapeHtml(p.id)}" type="button">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn small danger" data-act="del" data-id="${escapeHtml(p.id)}" type="button">Ø­Ø°Ù</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  adminTable.innerHTML = `
    <tr>
      <th>Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</th>
      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
      <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
      <th>Ø§Ù„Ø¯ÙˆØ§Ù…</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
    ${rows || `<tr><td colspan="7" style="color:var(--muted);padding:14px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>`}
  `;
}

adminTable.addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-act]");
  if(!btn) return;

  const act = btn.dataset.act;
  const id = btn.dataset.id;

  const idx = pharmacies.findIndex(x => String(x.id) === String(id));
  if(idx === -1){
    toast("Ø­Ø¯Ø« Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„");
    drawAdminTable();
    return;
  }
  const p = pharmacies[idx];

  if(act === "edit"){
    editingId = String(id);
    formTitle.textContent = "ØªØ¹Ø¯ÙŠÙ„ ØµÙŠØ¯Ù„ÙŠØ©";
    formHint.textContent = "Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸.";
    f_pharmacy.value = p.pharmacy || "";
    f_duty_date.value = normalizeDate(p.duty_date) || "";
    f_address.value = p.address || "";
    f_phone.value = p.phone || "";
    f_open.value = p.open || "";
    f_openAmpm.value = normalizeAmpm(p.open_ampm);
    f_close.value = p.close || "";
    f_closeAmpm.value = normalizeAmpm(p.close_ampm);
    saveBtn.textContent = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
    toast("ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø§Ù‡Ø²");
  }

  if(act === "del"){
    const ok = confirm("Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù Ù‡Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©ØŸ");
    if(!ok) return;
    deletePharmacy(id);
  }
});

async function deletePharmacy(id){
  try{
    await sbFetch(`${TABLE}?id=eq.${encodeURIComponent(id)}`, { method: "DELETE" });
    toast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
    await loadFromSupabase();
    if(editingId === String(id)) resetForm();
  }catch(err){
    console.error(err);
    alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
  }
}

saveBtn.addEventListener("click", async () => {
  const pharmacy = String(f_pharmacy.value).trim();
  const duty_date = normalizeDate(f_duty_date.value);
  const address = String(f_address.value).trim();
  const phone = String(f_phone.value).trim();
  const open = normalizeTime(f_open.value);
  const close = normalizeTime(f_close.value);
  const open_ampm = normalizeAmpm(f_openAmpm.value);
  const close_ampm = normalizeAmpm(f_closeAmpm.value);

  if(!pharmacy){
    formHint.textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©.";
    return;
  }
  if(!duty_date){
    formHint.textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­ Ø¨ØµÙŠØºØ© YYYY-MM-DD.";
    return;
  }
  if(!open || !close){
    formHint.textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„ 10:00) ÙˆØ¨Ù†Ø¸Ø§Ù… 12 Ø³Ø§Ø¹Ø©.";
    return;
  }

  const payload = { pharmacy, address, phone, duty_date, open, open_ampm, close, close_ampm };

  try{
    if(editingId){
      await sbFetch(`${TABLE}?id=eq.${encodeURIComponent(editingId)}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          "Prefer": "return=representation"
        },
        body: JSON.stringify(payload)
      });
      toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…");
    }else{
      await sbFetch(`${TABLE}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Prefer": "return=representation"
        },
        body: JSON.stringify(payload)
      });
      toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…");
    }

    resetForm();
    await loadFromSupabase();
  }catch(err){
    console.error(err);
    alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„ØµÙŠØº.");
  }
});

clearDataBtn.addEventListener("click", async () => {
  const ok = confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ");
  if(!ok) return;
  try{
    await sbFetch(`${TABLE}?id=not.is.null`, { method: "DELETE" });
    toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„");
    resetForm();
    await loadFromSupabase();
  }catch(err){
    console.error(err);
    alert("ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„.");
  }
});

excelFile.addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if(!file) return;

  try{
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, {type:"array"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:""});

    const mapped = rows.map(r => {
      const pharmacy = String(r.pharmacy ?? r["Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©"] ?? "").trim();
      const address  = String(r.address ?? r["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] ?? "").trim();
      const phone    = String(r.phone ?? r["Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"] ?? "").trim();
      const duty_date = normalizeDate(r.duty_date ?? r["Ø§Ù„ØªØ§Ø±ÙŠØ®"] ?? r["ØªØ§Ø±ÙŠØ®"] ?? "");

      const open = normalizeTime(r.open ?? r["ÙØªØ­"] ?? "");
      const open_ampm = normalizeAmpm(r.open_ampm ?? r["ÙØªØ­ AM/PM"] ?? r["AM/PM ÙØªØ­"] ?? "");

      const close = normalizeTime(r.close ?? r["Ø¥ØºÙ„Ø§Ù‚"] ?? r["Ø§ØºÙ„Ø§Ù‚"] ?? "");
      const close_ampm = normalizeAmpm(r.close_ampm ?? r["Ø¥ØºÙ„Ø§Ù‚ AM/PM"] ?? r["AM/PM Ø¥ØºÙ„Ø§Ù‚"] ?? r["AM/PM Ø§ØºÙ„Ø§Ù‚"] ?? "");

      return { pharmacy, address, phone, duty_date, open, open_ampm, close, close_ampm };
    }).filter(x => x.pharmacy && x.duty_date && x.open && x.close);

    if(mapped.length === 0){
      alert("Ù…Ø§ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙÙˆÙ ØµØ§Ù„Ø­Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª.");
      return;
    }

    await sbFetch(`${TABLE}?id=not.is.null`, { method:"DELETE" });

    await sbFetch(`${TABLE}`, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Prefer":"return=minimal"
      },
      body: JSON.stringify(mapped)
    });

    toast(`ØªÙ… Ø±ÙØ¹ Excel âœ… (${mapped.length})`);
    alert(`ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…\nØ¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${mapped.length}\n(ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)`);
    await loadFromSupabase();
    resetForm();
  }catch(err){
    console.error(err);
    alert("ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø©/Ø±ÙØ¹ Ù…Ù„Ù Excel. ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ .xlsx ÙˆØ£Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØµØ­ÙŠØ­Ø© (ÙˆØ®Ø§ØµØ© duty_date Ø¨ØµÙŠØºØ© YYYY-MM-DD).");
  }finally{
    excelFile.value = "";
  }
});

/* =========================
   Load from Supabase + Loading overlay
========================= */
async function loadFromSupabase(){
  const data = await sbFetch(`${TABLE}?select=*`, { method:"GET" });
  pharmacies = Array.isArray(data) ? data : [];
  drawAdminTable();
  renderPublic();
}

(function init(){
  todayBadge.textContent = formatArabicDateLabel(todayISO());

  const loading = document.getElementById("loading");
  const hardHide = () => {
    loading.classList.add("hide");
    setTimeout(()=> loading.style.display="none", 260);
  };

  const safetyTimer = setTimeout(() => {
    toast("ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„");
    hardHide();
  }, 7000);

  loadFromSupabase()
    .catch(err => {
      console.error(err);
      toast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    })
    .finally(() => {
      clearTimeout(safetyTimer);
      requestAnimationFrame(() => hardHide());
    });
})();
</script>
</body>
</html>
